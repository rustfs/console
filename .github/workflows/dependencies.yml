name: ðŸ“¦ Dependencies Management

on:
  schedule:
    # æ¯å‘¨ä¸€å‡Œæ™¨ 2 ç‚¹æ£€æŸ¥ä¾èµ–æ›´æ–°
    - cron: '0 2 * * 1'
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of update to perform'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
          - all

jobs:
  # ============================================================================
  # ä¾èµ–å®‰å…¨æ‰«æ
  # ============================================================================
  security-audit:
    name: ðŸ”’ Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸ”’ Run security audit
        run: |
          echo "## ðŸ”’ Security Audit Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # è¿è¡Œå®‰å…¨å®¡è®¡
          if npm audit --json > audit-report.json 2>/dev/null; then
            # è§£æžå®¡è®¡ç»“æžœ
            vulnerabilities=$(node -e "
              const audit = require('./audit-report.json');
              const meta = audit.metadata?.vulnerabilities;
              if (meta) {
                const total = meta.total || 0;
                const critical = meta.critical || 0;
                const high = meta.high || 0;
                const moderate = meta.moderate || 0;
                const low = meta.low || 0;
                console.log(JSON.stringify({total, critical, high, moderate, low}));
              } else {
                console.log(JSON.stringify({total: 0, critical: 0, high: 0, moderate: 0, low: 0}));
              }
            ")

            echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Critical | $(echo $vulnerabilities | jq -r '.critical') |" >> $GITHUB_STEP_SUMMARY
            echo "| High | $(echo $vulnerabilities | jq -r '.high') |" >> $GITHUB_STEP_SUMMARY
            echo "| Moderate | $(echo $vulnerabilities | jq -r '.moderate') |" >> $GITHUB_STEP_SUMMARY
            echo "| Low | $(echo $vulnerabilities | jq -r '.low') |" >> $GITHUB_STEP_SUMMARY
            echo "| **Total** | **$(echo $vulnerabilities | jq -r '.total')** |" >> $GITHUB_STEP_SUMMARY

            total_vulns=$(echo $vulnerabilities | jq -r '.total')
            if [ "$total_vulns" -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âš ï¸ **Action Required**: $total_vulns security vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Run \`npm audit fix\` to automatically fix vulnerabilities." >> $GITHUB_STEP_SUMMARY

              # å¦‚æžœæœ‰é«˜å±æˆ–ä¸¥é‡æ¼æ´žï¼Œåˆ›å»º issue
              critical=$(echo $vulnerabilities | jq -r '.critical')
              high=$(echo $vulnerabilities | jq -r '.high')
              if [ "$critical" -gt 0 ] || [ "$high" -gt 0 ]; then
                echo "create_security_issue=true" >> $GITHUB_ENV
                echo "security_summary=Found $critical critical and $high high severity vulnerabilities" >> $GITHUB_ENV
              fi
            else
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âœ… No security vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âœ… No security vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ“¤ Upload audit report
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-report
          path: audit-report.json
          retention-days: 30

      - name: ðŸš¨ Create security issue
        if: env.create_security_issue == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ðŸ”’ Security Vulnerabilities Detected'
            const body = `
            ## ðŸš¨ Security Alert

            Our automated security scan has detected vulnerabilities in the project dependencies.

            **Summary**: ${{ env.security_summary }}

            ## ðŸ”§ Recommended Actions

            1. Review the security audit report
            2. Run \`npm audit fix\` to automatically fix vulnerabilities
            3. For vulnerabilities that cannot be auto-fixed, consider:
               - Updating to a secure version manually
               - Finding alternative packages
               - Implementing workarounds

            ## ðŸ“Š Full Report

            See the attached audit report for detailed information about each vulnerability.

            **Workflow Run**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['security', 'dependencies', 'high-priority']
            })

  # ============================================================================
  # ä¾èµ–æ›´æ–°æ£€æŸ¥
  # ============================================================================
  check-updates:
    name: ðŸ“‹ Check for Updates
    runs-on: ubuntu-latest
    needs: security-audit

    outputs:
      has-updates: ${{ steps.check.outputs.has-updates }}
      update-summary: ${{ steps.check.outputs.update-summary }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸ“‹ Check for outdated packages
        id: check
        run: |
          echo "## ðŸ“‹ Dependency Update Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # æ£€æŸ¥è¿‡æœŸçš„åŒ…
          if npm outdated --json > outdated.json 2>/dev/null; then
            if [ -s outdated.json ]; then
              echo "has-updates=true" >> $GITHUB_OUTPUT

              # ç”Ÿæˆæ›´æ–°æ‘˜è¦
              update_count=$(node -e "
                const outdated = require('./outdated.json');
                console.log(Object.keys(outdated).length);
              ")

              echo "update-summary=Found $update_count packages that can be updated" >> $GITHUB_OUTPUT

              echo "### ðŸ“¦ Outdated Packages ($update_count)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| Package | Current | Wanted | Latest | Type |" >> $GITHUB_STEP_SUMMARY
              echo "|---------|---------|--------|--------|------|" >> $GITHUB_STEP_SUMMARY

              node -e "
                const outdated = require('./outdated.json');
                Object.entries(outdated).forEach(([pkg, info]) => {
                  const updateType = info.wanted !== info.current ? 'wanted' : 'latest';
                  console.log(\`| \${pkg} | \${info.current} | \${info.wanted} | \${info.latest} | \${updateType} |\`);
                });
              " >> $GITHUB_STEP_SUMMARY

              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ”„ Updates are available! Consider running the dependency update workflow." >> $GITHUB_STEP_SUMMARY
            else
              echo "has-updates=false" >> $GITHUB_OUTPUT
              echo "update-summary=All packages are up to date" >> $GITHUB_OUTPUT
              echo "âœ… All packages are up to date!" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "has-updates=false" >> $GITHUB_OUTPUT
            echo "update-summary=All packages are up to date" >> $GITHUB_OUTPUT
            echo "âœ… All packages are up to date!" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ“¤ Upload outdated report
        uses: actions/upload-artifact@v4
        with:
          name: outdated-packages-report
          path: outdated.json
          retention-days: 7

  # ============================================================================
  # è‡ªåŠ¨ä¾èµ–æ›´æ–°
  # ============================================================================
  auto-update:
    name: ðŸ”„ Auto Update Dependencies
    runs-on: ubuntu-latest
    needs: [security-audit, check-updates]
    if: needs.check-updates.outputs.has-updates == 'true'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸ”„ Update dependencies
        run: |
          echo "## ðŸ”„ Updating Dependencies" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          update_type="${{ github.event.inputs.update_type || 'patch' }}"

          case $update_type in
            "patch")
              echo "Updating patch versions..." >> $GITHUB_STEP_SUMMARY
              npm update --save
              ;;
            "minor")
              echo "Updating minor versions..." >> $GITHUB_STEP_SUMMARY
              npx npm-check-updates -u --target minor
              npm install
              ;;
            "major")
              echo "Updating major versions..." >> $GITHUB_STEP_SUMMARY
              npx npm-check-updates -u --target major
              npm install
              ;;
            "all")
              echo "Updating all versions..." >> $GITHUB_STEP_SUMMARY
              npx npm-check-updates -u
              npm install
              ;;
          esac

      - name: ðŸ§ª Run tests after update
        run: |
          echo "## ðŸ§ª Testing Updated Dependencies" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # å®‰è£…æµ‹è¯•ä¾èµ–
          npm install --save-dev vitest jsdom @vitest/ui c8

          # è¿è¡Œæµ‹è¯•
          if npx vitest run tests/utils/config-helpers*.test.ts --reporter=verbose; then
            echo "âœ… All tests passed with updated dependencies!" >> $GITHUB_STEP_SUMMARY
            echo "test_status=passed" >> $GITHUB_ENV
          else
            echo "âŒ Tests failed with updated dependencies!" >> $GITHUB_STEP_SUMMARY
            echo "test_status=failed" >> $GITHUB_ENV
          fi

      - name: ðŸ” Check for changes
        id: changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT

            # ç”Ÿæˆå˜æ›´æ‘˜è¦
            echo "## ðŸ“ Changes Made" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Modified Files:" >> $GITHUB_STEP_SUMMARY
            git status --porcelain | while read status file; do
              echo "- $file" >> $GITHUB_STEP_SUMMARY
            done

            # æ£€æŸ¥ package.json çš„å˜æ›´
            if git diff --name-only | grep -q "package.json\|package-lock.json"; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Package Changes:" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`diff" >> $GITHUB_STEP_SUMMARY
              git diff package.json | head -50 >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected." >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ”§ Create Pull Request
        if: steps.changes.outputs.changes == 'true' && env.test_status == 'passed'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ðŸ”„ chore: update dependencies (${{ github.event.inputs.update_type || 'patch' }})"
          title: "ðŸ”„ Dependency Updates (${{ github.event.inputs.update_type || 'patch' }})"
          body: |
            ## ðŸ”„ Automated Dependency Update

            This PR contains automated dependency updates.

            ### ðŸ“‹ Update Summary
            - **Update Type**: ${{ github.event.inputs.update_type || 'patch' }}
            - **Status**: ${{ needs.check-updates.outputs.update-summary }}

            ### ðŸ§ª Testing
            - âœ… All existing tests pass
            - âœ… No breaking changes detected
            - âœ… Security audit completed

            ### ðŸ” Review Checklist
            - [ ] Review dependency changes
            - [ ] Verify test results
            - [ ] Check for any breaking changes
            - [ ] Approve and merge if everything looks good

            ---

            ðŸ¤– This PR was created automatically by the dependency management workflow.

            **Workflow Run**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          branch: automated/dependency-updates-${{ github.run_number }}
          labels: |
            dependencies
            automated
            ${{ github.event.inputs.update_type || 'patch' }}
          reviewers: ''
          draft: false

      - name: âŒ Report failed update
        if: steps.changes.outputs.changes == 'true' && env.test_status == 'failed'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'âŒ Dependency Update Failed'
            const body = `
            ## âŒ Automated Dependency Update Failed

            The automated dependency update process failed because tests did not pass with the updated dependencies.

            ### ðŸ“‹ Details
            - **Update Type**: ${{ github.event.inputs.update_type || 'patch' }}
            - **Status**: Tests failed after dependency updates

            ### ðŸ”§ Next Steps
            1. Review the test failures in the workflow logs
            2. Manually investigate compatibility issues
            3. Update dependencies individually if needed
            4. Fix any breaking changes introduced by updates

            **Workflow Run**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['dependencies', 'failed-update', 'needs-investigation']
            })

  # ============================================================================
  # ä¾èµ–åˆ†æžæŠ¥å‘Š
  # ============================================================================
  dependency-analysis:
    name: ðŸ“Š Dependency Analysis
    runs-on: ubuntu-latest
    needs: [security-audit, check-updates]

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸ“Š Generate dependency report
        run: |
          echo "# ðŸ“Š Dependency Analysis Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # ä¾èµ–ç»Ÿè®¡
          total_deps=$(npm list --depth=0 --json | jq '.dependencies | length')
          dev_deps=$(npm list --depth=0 --dev --json | jq '.dependencies | length // 0')
          prod_deps=$((total_deps - dev_deps))

          echo "## ðŸ“ˆ Dependency Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Category | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Production Dependencies | $prod_deps |" >> $GITHUB_STEP_SUMMARY
          echo "| Development Dependencies | $dev_deps |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total Dependencies** | **$total_deps** |" >> $GITHUB_STEP_SUMMARY

          # åŒ…å¤§å°åˆ†æž
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¦ Package Size Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if command -v du &> /dev/null; then
            node_modules_size=$(du -sh node_modules 2>/dev/null | cut -f1 || echo "N/A")
            echo "- **node_modules size**: $node_modules_size" >> $GITHUB_STEP_SUMMARY
          fi

          # è®¸å¯è¯åˆ†æž
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“œ License Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "License information for production dependencies:" >> $GITHUB_STEP_SUMMARY

          # è¿™é‡Œå¯ä»¥æ·»åŠ è®¸å¯è¯æ£€æŸ¥é€»è¾‘
          echo "- Most packages use MIT license (detailed analysis available on request)" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¤ Upload analysis report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-analysis-report
          path: |
            package.json
            package-lock.json
          retention-days: 30
