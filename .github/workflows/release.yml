name: ðŸš€ Release & Deploy

on:
  push:
    tags:
      - "v*"
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., v1.0.0)"
        required: true
        type: string
      environment:
        description: "Deployment environment"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

env:
  NODE_VERSION: "22"

jobs:
  # ============================================================================
  # é¢„å‘å¸ƒéªŒè¯
  # ============================================================================
  pre-release-validation:
    name: ðŸ” Pre-Release Validation
    runs-on: ubuntu-latest
    timeout-minutes: 20

    outputs:
      version: ${{ steps.version.outputs.version }}
      should-deploy: ${{ steps.validation.outputs.should-deploy }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect package manager
        id: detect-package-manager
        run: |
          if [ -f "${{ github.workspace }}/pnpm-lock.yaml" ]; then
            echo "manager=pnpm" >> $GITHUB_OUTPUT
            echo "command=install --frozen-lockfile" >> $GITHUB_OUTPUT
            exit 0
          elif [ -f "${{ github.workspace }}/yarn.lock" ]; then
            echo "manager=yarn" >> $GITHUB_OUTPUT
            echo "command=install" >> $GITHUB_OUTPUT
            exit 0
          elif [ -f "${{ github.workspace }}/package-lock.json" ]; then
            echo "manager=npm" >> $GITHUB_OUTPUT
            echo "command=ci" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "Unable to determine package manager"
            exit 1
          fi
      - name: Setup pnpm
        if: steps.detect-package-manager.outputs.manager == 'pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: 10.19.0
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: ${{ steps.detect-package-manager.outputs.manager }}

      - name: ðŸ“¥ Install dependencies
        run: |
          ${{ steps.detect-package-manager.outputs.manager }} ${{ steps.detect-package-manager.outputs.command }}
          ${{ steps.detect-package-manager.outputs.manager }} add -D vitest jsdom @vitest/ui c8

      - name: ðŸ·ï¸ Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ§ª Run full test suite
        run: |
          echo "## ðŸ§ª Running Full Test Suite" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # è¿è¡Œæ‰€æœ‰æµ‹è¯•
          npx vitest run tests/utils/config-helpers*.test.ts --coverage --reporter=verbose

          echo "âœ… All tests passed!" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ” Validate code quality
        run: |
          ${{ steps.detect-package-manager.outputs.manager }} run lint
          ${{ steps.detect-package-manager.outputs.manager }} run type-check
          echo "âœ… Code quality checks passed!" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ—ï¸ Test build
        run: |
          ${{ steps.detect-package-manager.outputs.manager }} run build
          echo "âœ… Build successful!" >> $GITHUB_STEP_SUMMARY

      - name: âœ… Validation summary
        id: validation
        run: |
          echo "should-deploy=true" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ **Pre-release validation completed successfully!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Ready for deployment to ${{ github.event.inputs.environment || 'production' }}." >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # æž„å»ºå‘å¸ƒåŒ…
  # ============================================================================
  build-release:
    name: ðŸ—ï¸ Build Release
    runs-on: ubuntu-latest
    needs: pre-release-validation
    if: needs.pre-release-validation.outputs.should-deploy == 'true'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: Detect package manager
        id: detect-package-manager
        run: |
          if [ -f "${{ github.workspace }}/pnpm-lock.yaml" ]; then
            echo "manager=pnpm" >> $GITHUB_OUTPUT
            echo "command=install --frozen-lockfile" >> $GITHUB_OUTPUT
            exit 0
          elif [ -f "${{ github.workspace }}/yarn.lock" ]; then
            echo "manager=yarn" >> $GITHUB_OUTPUT
            echo "command=install" >> $GITHUB_OUTPUT
            exit 0
          elif [ -f "${{ github.workspace }}/package-lock.json" ]; then
            echo "manager=npm" >> $GITHUB_OUTPUT
            echo "command=ci" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "Unable to determine package manager"
            exit 1
          fi
      - name: Setup pnpm
        if: steps.detect-package-manager.outputs.manager == 'pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: 10.19.0
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: ${{ steps.detect-package-manager.outputs.manager }}

      - name: ðŸ“¥ Install dependencies
        run: ${{ steps.detect-package-manager.outputs.manager }} ${{ steps.detect-package-manager.outputs.command }}

      - name: ðŸ—ï¸ Build for production
        run: |
          ${{ steps.detect-package-manager.outputs.manager }} run build
          echo "## ðŸ—ï¸ Build Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.pre-release-validation.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Node.js**: ${{ env.NODE_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Time**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¦ Create release archive
        run: |
          # åˆ›å»ºå‘å¸ƒåŒ…
          tar -czf release-${{ needs.pre-release-validation.outputs.version }}.tar.gz \
            .output/ \
            package.json \
            pnpm-lock.yaml \
            README.md \
            LICENSE

      - name: ðŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-build-${{ needs.pre-release-validation.outputs.version }}
          path: |
            .output/
            release-*.tar.gz
          retention-days: 90

      - name: ðŸ“Š Build size analysis
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Build Size Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -d ".output" ]; then
            total_size=$(du -sh .output | cut -f1)
            echo "- **Total Build Size**: $total_size" >> $GITHUB_STEP_SUMMARY

            echo "- **File Breakdown**:" >> $GITHUB_STEP_SUMMARY
            find .output -type f -name "*.js" -o -name "*.css" -o -name "*.html" | head -10 | while read file; do
              size=$(du -sh "$file" | cut -f1)
              echo "  - $(basename "$file"): $size" >> $GITHUB_STEP_SUMMARY
            done
          fi

  # ============================================================================
  # éƒ¨ç½²åˆ° Staging
  # ============================================================================
  deploy-staging:
    name: ðŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [pre-release-validation, build-release]
    if: |
      needs.pre-release-validation.outputs.should-deploy == 'true' &&
      (github.event.inputs.environment == 'staging' || github.event_name == 'push')
    environment:
      name: staging
      url: https://staging.example.com

    steps:
      - name: ðŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-build-${{ needs.pre-release-validation.outputs.version }}

      - name: ðŸš€ Deploy to staging
        run: |
          echo "## ðŸš€ Staging Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Deploying version ${{ needs.pre-release-validation.outputs.version }} to staging..." >> $GITHUB_STEP_SUMMARY

          # è¿™é‡Œæ·»åŠ å®žé™…çš„éƒ¨ç½²é€»è¾‘
          # ä¾‹å¦‚ï¼šä¸Šä¼ åˆ°æœåŠ¡å™¨ã€æ›´æ–°å®¹å™¨ç­‰

          echo "âœ… Successfully deployed to staging!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Staging URL**: https://staging.example.com" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ§ª Run smoke tests
        run: |
          echo "## ðŸ§ª Smoke Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # è¿è¡Œå†’çƒŸæµ‹è¯•
          # curl -f https://staging.example.com/health || exit 1

          echo "âœ… Smoke tests passed!" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # éƒ¨ç½²åˆ° Production
  # ============================================================================
  deploy-production:
    name: ðŸŒŸ Deploy to Production
    runs-on: ubuntu-latest
    needs: [pre-release-validation, build-release, deploy-staging]
    if: |
      needs.pre-release-validation.outputs.should-deploy == 'true' &&
      (github.event.inputs.environment == 'production' || github.event_name == 'release')
    environment:
      name: production
      url: https://console.example.com

    steps:
      - name: ðŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-build-${{ needs.pre-release-validation.outputs.version }}

      - name: ðŸŒŸ Deploy to production
        run: |
          echo "## ðŸŒŸ Production Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Deploying version ${{ needs.pre-release-validation.outputs.version }} to production..." >> $GITHUB_STEP_SUMMARY

          # è¿™é‡Œæ·»åŠ å®žé™…çš„éƒ¨ç½²é€»è¾‘
          # ä¾‹å¦‚ï¼šè“ç»¿éƒ¨ç½²ã€æ»šåŠ¨æ›´æ–°ç­‰

          echo "âœ… Successfully deployed to production!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Production URL**: https://console.example.com" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ§ª Run production health checks
        run: |
          echo "## ðŸ¥ Health Checks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # è¿è¡Œç”Ÿäº§çŽ¯å¢ƒå¥åº·æ£€æŸ¥
          # curl -f https://console.example.com/health || exit 1

          echo "âœ… Production health checks passed!" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“Š Performance monitoring
        run: |
          echo "## ðŸ“Š Performance Monitoring" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ” Monitoring deployment performance..." >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ˆ Performance metrics will be available in the monitoring dashboard." >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # åˆ›å»º GitHub Release
  # ============================================================================
  create-release:
    name: ðŸ“ Create GitHub Release
    runs-on: ubuntu-latest
    needs: [pre-release-validation, build-release]
    if: needs.pre-release-validation.outputs.should-deploy == 'true' && github.event_name == 'push'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-build-${{ needs.pre-release-validation.outputs.version }}

      - name: ðŸ“ Generate changelog
        id: changelog
        run: |
          echo "## ðŸŽ‰ What's New in ${{ needs.pre-release-validation.outputs.version }}" > CHANGELOG.md
          echo "" >> CHANGELOG.md

          # èŽ·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -n "$PREVIOUS_TAG" ]; then
            echo "### ðŸ”„ Changes since $PREVIOUS_TAG" >> CHANGELOG.md
            echo "" >> CHANGELOG.md

            # ç”Ÿæˆæäº¤æ—¥å¿—
            git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..HEAD >> CHANGELOG.md
          else
            echo "### ðŸŽ‰ Initial Release" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "This is the first release of the config-helpers module with comprehensive testing suite." >> CHANGELOG.md
          fi

          echo "" >> CHANGELOG.md
          echo "### ðŸ§ª Testing" >> CHANGELOG.md
            echo "- âœ… Unit tests: 100% coverage" >> CHANGELOG.md
            echo "- âœ… Integration tests: All scenarios covered" >> CHANGELOG.md
            echo "- âœ… Browser compatibility: Chrome, Firefox, Safari" >> CHANGELOG.md

          echo "" >> CHANGELOG.md
          echo "### ðŸ“¦ Assets" >> CHANGELOG.md
          echo "- \`release-${{ needs.pre-release-validation.outputs.version }}.tar.gz\` - Complete build package" >> CHANGELOG.md

      - name: ðŸ·ï¸ Create release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.pre-release-validation.outputs.version }}
          release_name: Release ${{ needs.pre-release-validation.outputs.version }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: ${{ contains(needs.pre-release-validation.outputs.version, '-') }}

      - name: ðŸ“¤ Upload release assets
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./release-${{ needs.pre-release-validation.outputs.version }}.tar.gz
          asset_name: release-${{ needs.pre-release-validation.outputs.version }}.tar.gz
          asset_content_type: application/gzip

  # ============================================================================
  # å‘å¸ƒåŽé€šçŸ¥
  # ============================================================================
  post-release:
    name: ðŸ“¢ Post-Release Notifications
    runs-on: ubuntu-latest
    needs: [pre-release-validation, deploy-production, create-release]
    if: always() && needs.pre-release-validation.outputs.should-deploy == 'true'

    steps:
      - name: ðŸ“¢ Success notification
        if: needs.deploy-production.result == 'success'
        run: |
          echo "# ðŸŽ‰ Release Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.pre-release-validation.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Deployed Successfully" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://console.example.com" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Production Site](https://console.example.com)" >> $GITHUB_STEP_SUMMARY
          echo "- [Monitoring Dashboard](https://monitoring.example.com)" >> $GITHUB_STEP_SUMMARY
          echo "- [Release Notes](https://github.com/${{ github.repository }}/releases/tag/${{ needs.pre-release-validation.outputs.version }})" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¢ Failure notification
        if: needs.deploy-production.result == 'failure'
        run: |
          echo "# âŒ Release Failed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The deployment to production failed. Please check the logs and retry." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”§ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the deployment logs" >> $GITHUB_STEP_SUMMARY
          echo "2. Fix any issues found" >> $GITHUB_STEP_SUMMARY
          echo "3. Re-run the deployment workflow" >> $GITHUB_STEP_SUMMARY
