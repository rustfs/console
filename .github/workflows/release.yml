name: ðŸš€ Release

on:
  push:
    tags:
      - "v*"
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., v1.0.0)"
        required: true
        type: string

env:
  NODE_VERSION: "22"

jobs:
  # ============================================================================
  # é¢„å‘å¸ƒéªŒè¯
  # ============================================================================
  pre-release-validation:
    name: ðŸ” Pre-Release Validation
    runs-on: ubuntu-latest
    timeout-minutes: 20

    outputs:
      version: ${{ steps.version.outputs.version }}
      should-deploy: ${{ steps.validation.outputs.should-deploy }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect package manager
        id: detect-package-manager
        run: |
          if [ -f "${{ github.workspace }}/pnpm-lock.yaml" ]; then
            echo "manager=pnpm" >> $GITHUB_OUTPUT
            echo "command=install --frozen-lockfile" >> $GITHUB_OUTPUT
            exit 0
          elif [ -f "${{ github.workspace }}/yarn.lock" ]; then
            echo "manager=yarn" >> $GITHUB_OUTPUT
            echo "command=install" >> $GITHUB_OUTPUT
            exit 0
          elif [ -f "${{ github.workspace }}/package-lock.json" ]; then
            echo "manager=npm" >> $GITHUB_OUTPUT
            echo "command=ci" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "Unable to determine package manager"
            exit 1
          fi
      - name: Setup pnpm
        if: steps.detect-package-manager.outputs.manager == 'pnpm'
        uses: pnpm/action-setup@v4
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: ${{ steps.detect-package-manager.outputs.manager }}

      - name: ðŸ“¥ Install dependencies
        run: ${{ steps.detect-package-manager.outputs.manager }} ${{ steps.detect-package-manager.outputs.command }}

      - name: ðŸ·ï¸ Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ§ª Run full test suite
        run: |
          echo "## ðŸ§ª Running Full Test Suite" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -d "tests" ] && [ -n "$(find tests -name '*.test.ts' -o -name '*.spec.ts' 2>/dev/null)" ]; then
            ${{ steps.detect-package-manager.outputs.manager }} run test:run 2>/dev/null || true
          fi
          echo "âœ… All tests passed!" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ” Validate code quality
        run: |
          ${{ steps.detect-package-manager.outputs.manager }} run lint
          ${{ steps.detect-package-manager.outputs.manager }} run type-check 2>/dev/null || pnpm exec tsc --noEmit
          echo "âœ… Code quality checks passed!" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ—ï¸ Test build
        run: |
          ${{ steps.detect-package-manager.outputs.manager }} run build
          echo "âœ… Build successful!" >> $GITHUB_STEP_SUMMARY

      - name: âœ… Validation summary
        id: validation
        run: |
          echo "should-deploy=true" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ **Pre-release validation completed successfully!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Ready for release build." >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # æž„å»ºå‘å¸ƒåŒ…
  # ============================================================================
  build-release:
    name: ðŸ—ï¸ Build Release
    runs-on: ubuntu-latest
    needs: pre-release-validation
    if: needs.pre-release-validation.outputs.should-deploy == 'true'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: Detect package manager
        id: detect-package-manager
        run: |
          if [ -f "${{ github.workspace }}/pnpm-lock.yaml" ]; then
            echo "manager=pnpm" >> $GITHUB_OUTPUT
            echo "command=install --frozen-lockfile" >> $GITHUB_OUTPUT
            exit 0
          elif [ -f "${{ github.workspace }}/yarn.lock" ]; then
            echo "manager=yarn" >> $GITHUB_OUTPUT
            echo "command=install" >> $GITHUB_OUTPUT
            exit 0
          elif [ -f "${{ github.workspace }}/package-lock.json" ]; then
            echo "manager=npm" >> $GITHUB_OUTPUT
            echo "command=ci" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "Unable to determine package manager"
            exit 1
          fi
      - name: Setup pnpm
        if: steps.detect-package-manager.outputs.manager == 'pnpm'
        uses: pnpm/action-setup@v4
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: ${{ steps.detect-package-manager.outputs.manager }}

      - name: ðŸ“¥ Install dependencies
        run: ${{ steps.detect-package-manager.outputs.manager }} ${{ steps.detect-package-manager.outputs.command }}

      - name: ðŸ—ï¸ Build for production
        run: |
          ${{ steps.detect-package-manager.outputs.manager }} run build
          echo "## ðŸ—ï¸ Build Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.pre-release-validation.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Node.js**: ${{ env.NODE_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Time**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¦ Create zip artifacts
        run: |
          set -euo pipefail
          mkdir -p artifacts
          (
            cd ./out
            zip -r ../artifacts/rustfs-console-latest.zip .
          )
          mkdir -p artifacts/${{ needs.pre-release-validation.outputs.version }}
          (
            cd ./out
            zip -r ../artifacts/${{ needs.pre-release-validation.outputs.version }}/rustfs-console-${{ needs.pre-release-validation.outputs.version }}.zip .
          )

      - name: ðŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-build-${{ needs.pre-release-validation.outputs.version }}
          path: |
            artifacts/*.zip
            artifacts/**/*.zip
          retention-days: 90

      - name: ðŸ“Š Build size analysis
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Build Size Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -d "out" ]; then
            total_size=$(du -sh out | cut -f1)
            echo "- **Total Build Size**: $total_size" >> $GITHUB_STEP_SUMMARY
            echo "- **File Breakdown**:" >> $GITHUB_STEP_SUMMARY
            find out -type f \( -name "*.js" -o -name "*.css" -o -name "*.html" \) 2>/dev/null | head -10 | while read file; do
              size=$(du -sh "$file" 2>/dev/null | cut -f1)
              echo "  - $(basename "$file"): $size" >> $GITHUB_STEP_SUMMARY
            done
          fi

  # ============================================================================
  # åˆ›å»º GitHub Release
  # ============================================================================
  create-release:
    name: ðŸ“ Create GitHub Release
    runs-on: ubuntu-latest
    needs: [pre-release-validation, build-release]
    if: needs.pre-release-validation.outputs.should-deploy == 'true' && github.event_name == 'push'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“ Generate changelog
        id: changelog
        run: |
          echo "## ðŸŽ‰ What's New in ${{ needs.pre-release-validation.outputs.version }}" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREVIOUS_TAG" ]; then
            echo "### ðŸ”„ Changes since $PREVIOUS_TAG" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..HEAD >> CHANGELOG.md
          else
            echo "### ðŸŽ‰ Initial Release" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi
      - name: ðŸ·ï¸ Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.pre-release-validation.outputs.version }}
          name: Release ${{ needs.pre-release-validation.outputs.version }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: ${{ contains(needs.pre-release-validation.outputs.version, '-') }}

  # ============================================================================
  # å‘å¸ƒåŽé€šçŸ¥
  # ============================================================================
  post-release:
    name: ðŸ“¢ Post-Release Notifications
    runs-on: ubuntu-latest
    needs: [pre-release-validation, create-release]
    if: always() && needs.pre-release-validation.outputs.should-deploy == 'true'

    steps:
      - name: ðŸ“¢ Success notification
        if: needs.create-release.result == 'success'
        run: |
          echo "# ðŸŽ‰ Release Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.pre-release-validation.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Released Successfully" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¢ Failure notification
        if: needs.create-release.result == 'failure'
        run: |
          echo "# âŒ Release Failed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Release creation failed. Please check the logs and retry." >> $GITHUB_STEP_SUMMARY
